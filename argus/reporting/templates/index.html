<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Argus Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      /* Color Palette (Slate-based with Emerald Accents) */
      --bg-base: #f8fafc;
      --bg-panel: #ffffff;
      --bg-subtle: #f1f5f9;
      --bg-hover: #e2e8f0;

      --text-main: #0f172a;
      --text-muted: #64748b;
      --text-inverse: #ffffff;

      --border-color: #cbd5e1;
      --border-subtle: #e2e8f0;

      --primary: #0f766e;
      --primary-hover: #115e59;
      --primary-subtle: #ccfbf1;
      --primary-text: #0f766e;

      --success: #16a34a;
      --success-subtle: #dcfce7;
      --success-text: #15803d;

      --error: #dc2626;
      --error-subtle: #fee2e2;
      --error-text: #b91c1c;

      --warning: #ca8a04;
      --warning-subtle: #fef9c3;
      --warning-text: #854d0e;

      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);

      --font-stack: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Dark Mode Overrides (Explicit class instead of just media query) */
    html.dark {
      --bg-base: #0f172a;
      --bg-panel: #1e293b;
      --bg-subtle: #334155;
      --bg-hover: #475569;

      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --text-inverse: #0f172a;

      --border-color: #334155;
      --border-subtle: #1e293b;

      --primary: #14b8a6;
      --primary-hover: #2dd4bf;
      --primary-subtle: #134e4a;
      --primary-text: #5eead4;

      --success: #22c55e;
      --success-subtle: #14532d;
      --success-text: #86efac;

      --error: #ef4444;
      --error-subtle: #7f1d1d;
      --error-text: #fca5a5;

      --warning: #eab308;
      --warning-subtle: #713f12;
      --warning-text: #fde047;
    }

    /* Reset & Base */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background-color: var(--bg-base);
      color: var(--text-main);
      font-family: var(--font-stack);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
      display: flex;
      min-height: 100vh;
    }

    a {
      color: var(--primary);
      text-decoration: none;
      transition: color 0.15s;
    }

    a:hover {
      color: var(--primary-hover);
      text-decoration: underline;
    }

    /* Layout */
    .app-shell {
      display: grid;
      grid-template-columns: 240px 1fr;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      background-color: var(--bg-panel);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 12px;
      gap: 16px;
    }

    .brand {
      font-weight: 700;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-main);
      text-decoration: none;
    }

    .brand svg {
      width: 24px;
      height: 24px;
      color: var(--primary);
    }

    .nav-links {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      padding: 8px 12px;
      border-radius: var(--radius-md);
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .nav-item:hover {
      background-color: var(--bg-subtle);
      color: var(--text-main);
    }

    .nav-item.active {
      background-color: var(--primary-subtle);
      color: var(--primary-text);
    }

    .nav-item svg {
      width: 18px;
      height: 18px;
      opacity: 0.8;
    }

    /* Main Content */
    .main-content {
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }

    /* Cards */
    .card {
      background-color: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-sm);
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* Grid Layouts */
    .grid-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background-color: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-main);
    }

    .stat-trend {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .trend-up {
      color: var(--success-text);
    }

    .trend-down {
      color: var(--error-text);
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      background-color: var(--bg-subtle);
      text-align: left;
      padding: 12px 16px;
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-subtle);
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background-color: var(--bg-subtle);
    }

    td a {
      font-weight: 600;
      color: var(--primary);
      text-decoration: underline;
      text-decoration-color: var(--primary-subtle);
      text-underline-offset: 4px;
    }

    td a:hover {
      text-decoration-color: var(--primary);
    }

    /* Pills & Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge.success {
      background-color: var(--success-subtle);
      color: var(--success-text);
    }

    .badge.error {
      background-color: var(--error-subtle);
      color: var(--error-text);
    }

    .badge.warning {
      background-color: var(--warning-subtle);
      color: var(--warning-text);
    }

    .badge.neutral {
      background-color: var(--bg-subtle);
      color: var(--text-muted);
    }

    /* Filters & Inputs */
    .filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    input,
    select,
    button {
      font-family: inherit;
      font-size: 0.9rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      background-color: var(--bg-panel);
      color: var(--text-main);
      outline: none;
      transition: all 0.15s;
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-subtle);
    }

    button {
      cursor: pointer;
      font-weight: 500;
      background-color: var(--bg-subtle);
    }

    button:hover {
      background-color: var(--bg-hover);
    }

    button.primary {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    button.primary:hover {
      background-color: var(--primary-hover);
    }

    /* Chat / Transcript View */
    .chat-transcript {
      display: flex;
      flex-direction: column;
      gap: 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    .message-row {
      display: flex;
      gap: 16px;
      width: 100%;
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--bg-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 1.2rem;
    }

    .message-body {
      max-width: 80%;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message-bubble {
      padding: 16px;
      border-radius: var(--radius-lg);
      line-height: 1.6;
      font-size: 0.95rem;
      position: relative;
      box-shadow: var(--shadow-sm);
    }

    .message-row.user .message-bubble {
      background-color: var(--primary);
      /* Use primary color for user */
      color: white;
      border-bottom-right-radius: 2px;
    }

    .message-row.assistant .message-bubble {
      background-color: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-bottom-left-radius: 2px;
    }

    .message-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
    }

    /* Reasoning / Thinking */
    .thinking-block {
      background-color: var(--bg-subtle);
      border-left: 3px solid var(--primary);
      /* Lighter accent */
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 12px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .thinking-header {
      font-weight: 700;
      margin-bottom: 8px;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .thinking-header::before {
      content: '';
      display: inline-block;
      width: 12px;
      height: 12px;
      background-color: var(--primary);
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z'%3E%3C/path%3E%3Cpath d='M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z'%3E%3C/path%3E%3C/svg%3E") no-repeat center;
      mask-size: contain;
    }

    .thinking-content {
      font-style: italic;
      color: var(--text-muted);
    }

    .divider {
      height: 1px;
      background-color: var(--border-subtle);
      margin: 16px 0;
      width: 100%;
    }

    /* Tool Usage */
    .tool-block {
      background-color: var(--bg-base);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
      margin: 8px 0;
      font-family: var(--font-mono);
      font-size: 0.85rem;
    }

    .tool-header {
      background-color: var(--bg-subtle);
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tool-name {
      font-weight: 600;
      color: var(--text-main);
    }

    .tool-args {
      padding: 12px;
      background-color: var(--bg-panel);
      overflow-x: auto;
      color: var(--text-main);
    }

    .tool-result {
      padding: 12px;
      border-top: 1px solid var(--border-color);
      background-color: var(--bg-subtle);
      color: var(--text-muted);
    }

    /* Code Blocks */
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

    .flex-center {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .spinner {
      border: 3px solid var(--bg-subtle);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    /* Compare View */
    .compare-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .compare-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .compare-grid .chat-transcript {
      max-width: none;
      margin: 0;
    }

    .compare-grid .message-body {
      min-width: 0;
      max-width: 100%;
    }

    .compare-grid .message-bubble {
      font-size: 0.9rem;
    }

    .diff {
      background: linear-gradient(0deg, var(--warning-subtle), var(--warning-subtle));
      border-radius: var(--radius-sm);
      padding: 2px 6px;
      display: inline-block;
    }

    @media (max-width: 980px) {
      .compare-grid {
        grid-template-columns: 1fr;
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <aside class="sidebar">
      <a href="/" class="brand" onclick="app.navigate(event, '/')">
        <svg fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2L2 22h20L12 2zm0 3.5L18.5 20H5.5L12 5.5zM11 16v2h2v-2h-2zm0-6v4h2v-4h-2z" />
        </svg>
        Argus
      </a>
      <nav class="nav-links">
        <div class="nav-item" data-route="/" onclick="app.navigate(event, '/')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          Dashboard
        </div>
        <div class="nav-item" data-route="/runs" onclick="app.navigate(event, '/runs')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          Runs
        </div>
        <div class="nav-item" data-route="/compare" onclick="app.navigate(event, '/compare')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 3h5v5"></path>
            <path d="M8 21H3v-5"></path>
            <path d="M21 3l-7 7"></path>
            <path d="M3 21l7-7"></path>
          </svg>
          Compare
        </div>
        <div class="nav-item" data-route="/review-queue" onclick="app.navigate(event, '/review-queue')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"></path>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
          </svg>
          Review Queue
        </div>
        <div class="nav-item" data-route="/scenarios" onclick="app.navigate(event, '/scenarios')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
          </svg>
          Scenarios
        </div>
        <div class="nav-item" data-route="/suites" onclick="app.navigate(event, '/suites')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          Suites
        </div>
      </nav>

      <div style="margin-top: auto; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
        <div class="nav-item" onclick="app.toggleTheme()">
          <svg id="theme-icon-light" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <span id="theme-text">Dark Mode</span>
        </div>
      </div>
    </aside>

    <main class="main-content" id="app-root">
      <!-- Dynamic Content Injected Here -->
      <div class="flex-center">
        <div class="spinner"></div>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = '/api';

    // Application Logic
    const app = {
      state: {
        route: '/',
        params: {},
        darkMode: window.matchMedia('(prefers-color-scheme: dark)').matches
      },

      init() {
        // Theme init
        this.state.darkMode = localStorage.getItem('theme') === 'dark' ||
          (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
        this.applyTheme();

        window.addEventListener('popstate', () => this.handleRoute());
        this.handleRoute(); // Initial load
      },

      toggleTheme() {
        this.state.darkMode = !this.state.darkMode;
        localStorage.setItem('theme', this.state.darkMode ? 'dark' : 'light');
        this.applyTheme();
      },

      applyTheme() {
        document.documentElement.classList.toggle('dark', this.state.darkMode);
        const text = document.getElementById('theme-text');
        const iconLight = document.getElementById('theme-icon-light');
        const iconDark = document.getElementById('theme-icon-dark');

        if (text) text.textContent = this.state.darkMode ? 'Light Mode' : 'Dark Mode';
        if (iconLight) iconLight.classList.toggle('hidden', !this.state.darkMode);
        if (iconDark) iconDark.classList.toggle('hidden', this.state.darkMode);
      },

      navigate(event, path) {
        if (event) event.preventDefault();
        history.pushState(null, '', path);
        this.handleRoute();
      },

      async handleRoute() {
        const path = window.location.pathname;
        this.state.route = path;

        // Update Sidebar
        document.querySelectorAll('.nav-item').forEach(el => {
          el.classList.toggle('active', path === el.dataset.route || (el.dataset.route !== '/' && path.startsWith(el.dataset.route)));
        });

        const root = document.getElementById('app-root');
        root.innerHTML = '<div class="flex-center"><div class="spinner"></div></div>'; // Loading state

        try {
          if (path === '/') {
            await this.renderDashboard(root);
          } else if (path.startsWith('/runs/')) {
            const runId = path.split('/runs/')[1];
            await this.renderRunDetail(root, runId);
          } else if (path === '/runs') {
            await this.renderRunList(root);
          } else if (path.startsWith('/compare')) {
            await this.renderCompareDetail(root);
          } else if (path === '/review-queue') {
            await this.renderReviewQueue(root);
          } else if (path.startsWith('/scenarios/')) {
            const scenarioId = path.split('/scenarios/')[1];
            if (path.endsWith('/runs')) {
              // Might handle specific sub-view, but for now reuse detail
              await this.renderScenarioDetail(root, scenarioId);
            } else {
              await this.renderScenarioDetail(root, scenarioId);
            }
          } else if (path.startsWith('/jobs/')) {
            const jobId = path.split('/jobs/')[1];
            await this.renderJobDetail(root, jobId);
          } else if (path === '/scenarios') {
            await this.renderScenarioList(root);
          } else if (path.startsWith('/suites/')) {
            const suiteId = path.split('/suites/')[1];
            await this.renderSuiteDetail(root, suiteId);
          } else if (path === '/suites') {
            await this.renderSuiteList(root);
          } else {
            root.innerHTML = '<h2>404 Not Found</h2>';
          }
        } catch (err) {
          console.error(err);
          root.innerHTML = `<div class="card"><h2>Error</h2><p>${err.message}</p></div>`;
        }
      },

      // --- Renderers ---

      async renderDashboard(root) {
        // Fetch summary data (scams logic?)
        // Currently no dedicated dashboard API. We can fetch top runs.
        const runsData = await this.fetchJSON(`${API_BASE}/runs?page_size=5`);
        const scenariosData = await this.fetchJSON(`${API_BASE}/scenarios?page_size=5`);
        const reviewQueueData = await this.fetchJSON(`${API_BASE}/review-queue?page_size=5&latest_only=true`);
        const reasonCounts = reviewQueueData.summary?.reason_counts || {};

        const html = `
          <div class="page-header">
            <h1 class="page-title">Dashboard</h1>
          </div>
          <div class="grid-stats">
            <div class="stat-card">
              <span class="stat-label">Total Scenarios</span>
              <span class="stat-value">${scenariosData.total}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Recent Runs</span>
              <span class="stat-value">${runsData.total}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Needs Review</span>
              <span class="stat-value">${reviewQueueData.total}</span>
            </div>
          </div>
          
          <div class="card">
            <h2>Recent Runs</h2>
            ${this.buildRunsTable(runsData.items)}
          </div>

          <div class="card">
            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:12px;">
              <h2 style="margin:0;">Review Queue</h2>
              <a href="/review-queue" onclick="app.navigate(event, '/review-queue')">Open full queue &rarr;</a>
            </div>
            <div class="text-muted" style="margin-bottom:12px;">
              Reasons: ${Object.entries(reasonCounts).map(([k, v]) => `${k}=${v}`).join(' • ') || 'none'}
            </div>
            ${this.buildReviewQueueTable(reviewQueueData.items || [])}
          </div>
        `;
        root.innerHTML = html;
      },

      async renderRunList(root) {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 1;
        const scenarioId = urlParams.get('scenario_id') || '';
        const model = urlParams.get('model') || '';
        const passed = urlParams.get('passed') || '';
        const toolMode = urlParams.get('tool_mode') || '';
        const latestOnly = urlParams.get('latest_only') || 'false';

        let apiUrl = `${API_BASE}/runs?page=${page}&page_size=25`;
        if (scenarioId) apiUrl += `&scenario_id=${encodeURIComponent(scenarioId)}`;
        if (model) apiUrl += `&model=${encodeURIComponent(model)}`;
        if (passed) apiUrl += `&passed=${passed}`;
        if (toolMode) apiUrl += `&tool_mode=${encodeURIComponent(toolMode)}`;
        if (latestOnly) apiUrl += `&latest_only=${latestOnly}`;

        const data = await this.fetchJSON(apiUrl);

        root.innerHTML = `
          <div class="page-header">
            <h1 class="page-title">Run Reports</h1>
            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
              <button onclick="app.rescoreRunsFromFilters(false)">Rescore Filtered</button>
              <button class="primary" onclick="app.rescoreRunsFromFilters(true)">Rescore All</button>
            </div>
          </div>
          
          <div class="card" style="margin-bottom: 16px;">
            <div class="filters">
              <div class="filter-group">
                <span class="filter-label">Scenario ID</span>
                <input type="text" id="filter-scenario" placeholder="Search..." value="${scenarioId}">
              </div>
              <div class="filter-group">
                <span class="filter-label">Model</span>
                <input type="text" id="filter-model" placeholder="Model..." value="${model}">
              </div>
              <div class="filter-group">
                <span class="filter-label">Status</span>
                <select id="filter-passed">
                  <option value="">All</option>
                  <option value="true" ${passed === 'true' ? 'selected' : ''}>Pass</option>
                  <option value="false" ${passed === 'false' ? 'selected' : ''}>Fail</option>
                </select>
              </div>
              <div class="filter-group">
                <span class="filter-label">Tool Mode</span>
                <select id="filter-tool-mode">
                  <option value="">All</option>
                  <option value="enforce" ${toolMode === 'enforce' ? 'selected' : ''}>Enforce</option>
                  <option value="raw_tools_terminate" ${toolMode === 'raw_tools_terminate' ? 'selected' : ''}>Raw (Terminate)</option>
                  <option value="allow_forbidden_tools" ${toolMode === 'allow_forbidden_tools' ? 'selected' : ''}>Allow Forbidden</option>
                </select>
              </div>
              <div class="filter-group">
                <span class="filter-label">Latest per Scenario+Model+Tool</span>
                <select id="filter-latest-only">
                  <option value="false" ${latestOnly === 'false' ? 'selected' : ''}>No</option>
                  <option value="true" ${latestOnly === 'true' ? 'selected' : ''}>Yes</option>
                </select>
              </div>
              <div class="filter-group" style="justify-content: flex-end;">
                 <button class="primary" onclick="app.applyRunFilters()">Apply Filters</button>
              </div>
            </div>
          </div>

          <div class="card">
             ${this.buildRunsTable(data.items)}
             <div class="pagination" style="margin-top: 16px; display: flex; gap: 8px;">
               <button ${data.page <= 1 ? 'disabled' : ''} onclick="app.changePage(${data.page - 1})">Prev</button>
               <span style="align-self:center">Page ${data.page} of ${Math.ceil(data.total / data.page_size)} (${data.total} total)</span>
               <button ${data.page * data.page_size >= data.total ? 'disabled' : ''} onclick="app.changePage(${data.page + 1})">Next</button>
             </div>
          </div>
        `;
      },

      applyRunFilters() {
        const scenario = document.getElementById('filter-scenario').value;
        const model = document.getElementById('filter-model').value;
        const passed = document.getElementById('filter-passed').value;
        const toolMode = document.getElementById('filter-tool-mode').value;
        const latestOnly = document.getElementById('filter-latest-only').value;
        const url = new URL(window.location);
        url.searchParams.set('page', '1');
        if (scenario) url.searchParams.set('scenario_id', scenario); else url.searchParams.delete('scenario_id');
        if (model) url.searchParams.set('model', model); else url.searchParams.delete('model');
        if (passed) url.searchParams.set('passed', passed); else url.searchParams.delete('passed');
        if (toolMode) url.searchParams.set('tool_mode', toolMode); else url.searchParams.delete('tool_mode');
        if (latestOnly) url.searchParams.set('latest_only', latestOnly); else url.searchParams.delete('latest_only');
        history.pushState(null, '', url);
        this.handleRoute();
      },

      async rescoreRunsFromFilters(ignoreFilters) {
        const scenario = document.getElementById('filter-scenario')?.value || '';
        const model = document.getElementById('filter-model')?.value || '';
        const toolMode = document.getElementById('filter-tool-mode')?.value || '';
        const passed = document.getElementById('filter-passed')?.value || '';

        if (!ignoreFilters && !scenario && !model && !toolMode && !passed) {
          if (!confirm("No filters set. Rescore everything?")) return;
          ignoreFilters = true;
        }

        const label = ignoreFilters ? "ALL runs" : "filtered runs";
        if (!confirm(`Rescore ${label} using the latest scenario YAML(s)? This updates stored scorecards.`)) return;

        try {
          // Bulk rescore supports scenario_id + model filters. (Status/tool_mode filters don't affect scoring.)
          const body = {
            reason: ignoreFilters ? 'dashboard_bulk_rescore_all' : 'dashboard_bulk_rescore_filtered',
          };
          if (!ignoreFilters && scenario) body.scenario_id = scenario;
          if (!ignoreFilters && model) body.model = model;

          const res = await fetch(`${API_BASE}/runs/rescore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          if (!res.ok) throw new Error("Failed to bulk rescore runs");
          const data = await res.json();
          const skipped = (data.skipped_runs ?? 0);
          alert(`Rescore complete. Candidate=${data.candidate_runs} Rescored=${data.rescored_runs} Skipped=${skipped} Changed=${data.changed_runs} Errors=${(data.errors || []).length}`);
          this.handleRoute();
        } catch (err) {
          alert("Error: " + err.message);
        }
      },

      async renderReviewQueue(root) {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 1;
        const scenarioId = urlParams.get('scenario_id') || '';
        const model = urlParams.get('model') || '';
        const includePassed = urlParams.get('include_passed') || '';
        const latestOnly = urlParams.get('latest_only') || 'true';

        let apiUrl = `${API_BASE}/review-queue?page=${page}&page_size=25&latest_only=${latestOnly}`;
        if (scenarioId) apiUrl += `&scenario_id=${encodeURIComponent(scenarioId)}`;
        if (model) apiUrl += `&model=${encodeURIComponent(model)}`;
        if (includePassed) apiUrl += `&include_passed=${includePassed}`;

        const data = await this.fetchJSON(apiUrl);
        const summary = data.summary || {};
        const reasons = summary.reason_counts || {};

        root.innerHTML = `
          <div class="page-header">
            <h1 class="page-title">Review Queue</h1>
          </div>
          
          <div class="grid-stats" style="margin-bottom:16px;">
            <div class="stat-card">
              <span class="stat-label">Queue Size</span>
              <span class="stat-value">${data.total}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Total Runs</span>
              <span class="stat-value">${summary.total_runs || 0}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Fail Runs</span>
              <span class="stat-value">${summary.fail_runs || 0}</span>
            </div>
          </div>

          <div class="card" style="margin-bottom: 16px;">
            <div class="filters">
              <div class="filter-group">
                <span class="filter-label">Scenario ID</span>
                <input type="text" id="review-filter-scenario" placeholder="Search..." value="${scenarioId}">
              </div>
              <div class="filter-group">
                <span class="filter-label">Model</span>
                <input type="text" id="review-filter-model" placeholder="Model..." value="${model}">
              </div>
              <div class="filter-group">
                <span class="filter-label">Latest per Scenario+Model</span>
                <select id="review-filter-latest">
                  <option value="true" ${latestOnly === 'true' ? 'selected' : ''}>Yes</option>
                  <option value="false" ${latestOnly === 'false' ? 'selected' : ''}>No</option>
                </select>
              </div>
              <div class="filter-group">
                <span class="filter-label">Include Passed Clean Runs</span>
                <select id="review-filter-passed">
                  <option value="" ${!includePassed ? 'selected' : ''}>No</option>
                  <option value="true" ${includePassed === 'true' ? 'selected' : ''}>Yes</option>
                </select>
              </div>
              <div class="filter-group" style="justify-content: flex-end;">
                 <button class="primary" onclick="app.applyReviewFilters()">Apply Filters</button>
              </div>
            </div>
            <div class="text-muted">
              Reasons: ${Object.entries(reasons).map(([k, v]) => `${k}=${v}`).join(' • ') || 'none'}
            </div>
          </div>

          <div class="card">
             ${this.buildReviewQueueTable(data.items || [])}
             <div class="pagination" style="margin-top: 16px; display: flex; gap: 8px;">
               <button ${data.page <= 1 ? 'disabled' : ''} onclick="app.changePage(${data.page - 1})">Prev</button>
               <span style="align-self:center">Page ${data.page} of ${Math.ceil(data.total / data.page_size)} (${data.total} total)</span>
               <button ${data.page * data.page_size >= data.total ? 'disabled' : ''} onclick="app.changePage(${data.page + 1})">Next</button>
             </div>
          </div>
        `;
      },

      applyReviewFilters() {
        const scenario = document.getElementById('review-filter-scenario').value;
        const model = document.getElementById('review-filter-model').value;
        const latestOnly = document.getElementById('review-filter-latest').value;
        const includePassed = document.getElementById('review-filter-passed').value;

        const url = new URL(window.location);
        url.searchParams.set('page', '1');
        if (scenario) url.searchParams.set('scenario_id', scenario); else url.searchParams.delete('scenario_id');
        if (model) url.searchParams.set('model', model); else url.searchParams.delete('model');
        if (latestOnly) url.searchParams.set('latest_only', latestOnly); else url.searchParams.delete('latest_only');
        if (includePassed) url.searchParams.set('include_passed', includePassed); else url.searchParams.delete('include_passed');
        history.pushState(null, '', url);
        this.handleRoute();
      },

      async renderRunDetail(root, runId) {
        // Parallel fetch for summary and timeline
        const [runData, timelineData] = await Promise.all([
          this.fetchJSON(`${API_BASE}/runs/${runId}`),
          this.fetchJSON(`${API_BASE}/runs/${runId}/timeline`) // Handles separate timeline endpoint
        ]);

        const steps = timelineData.steps || [];
        const systemPrompt = runData.run?.runtime_summary?.setup_visible_context;
        const chatHtml = this.renderTranscript(steps, systemPrompt);

        const scenarioId = runData.scorecard?.scenario_id || runData.run?.scenario_id || '';
        const modelName = runData.scorecard?.model || runData.run?.model || '';
        const rs = runData.run?.runtime_summary || {};
        let toolGateMode = rs.tool_gate_mode || '';
        if (!toolGateMode) {
          if (rs.allow_forbidden_tools) toolGateMode = 'allow_forbidden_tools';
          else if (rs.terminate_on_blocked_tool_call) toolGateMode = 'raw_tools_terminate';
          else toolGateMode = 'enforce';
        }

        const isAcknowledged = (runData.review?.status === 'acknowledged');
        const lastRescoredAt = runData.rescoring?.last_rescored_at;
        const judgeCompare = runData.run?.runtime_summary?.llm_judge_compare;
        const judgeBadge = judgeCompare?.enabled
          ? `<span class="badge ${judgeCompare.disagreement_count > 0 ? 'warning' : 'neutral'}" style="font-size:0.9rem; padding:6px 12px;">AI Compare ${this.escapeHtml(judgeCompare.judge_model || '')}: ${judgeCompare.disagreement_count || 0} diff</span>`
          : '';

        root.innerHTML = `
           <div class="page-header">
            <h1 class="page-title">Run ${runId}</h1>
            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                 ${lastRescoredAt ? `<span class="badge neutral" style="font-size:0.9rem; padding:6px 12px;">Rescored ${this.escapeHtml(lastRescoredAt)}</span>` : ''}
                 ${judgeBadge}
                 <button onclick="app.rescoreRun('${runId}')">Rescore</button>
                 <button onclick="app.judgeCompareRun('${runId}')">AI Compare</button>
                 <button onclick="app.compareFromRun('${runId}')">Compare…</button>
                 ${isAcknowledged
            ? '<span class="badge success" style="font-size:0.9rem; padding:6px 12px;">Reviewed ✅</span>'
            : `<button id="btn-ack" onclick="app.ackRun('${runId}')">Mark as Reviewed</button>`
          }
            </div>
          </div>
          <div class="text-muted" style="margin-top:-6px; margin-bottom:12px;">
            ${scenarioId ? `<a href="/scenarios/${this.escapeHtml(scenarioId)}" onclick="app.navigate(event, '/scenarios/${this.escapeHtml(scenarioId)}')">&larr; Back to ${this.escapeHtml(scenarioId)}</a>` : ''}
          </div>
          <div class="grid-stats">
             <div class="stat-card">
               <span class="stat-label">Status</span>
               <span class="stat-value">${runData.scorecard.passed ? '<span class=trend-up>PASS</span>' : '<span class=trend-down>FAIL</span>'}</span>
             </div>
             <div class="stat-card">
               <span class="stat-label">Grade</span>
               <span class="stat-value">${runData.scorecard.grade}</span>
             </div>
             <div class="stat-card">
               <span class="stat-label">Checks Passed</span>
                <span class="stat-value">${runData.scorecard.checks.filter(c => c.passed).length}/${runData.scorecard.checks.length}</span>
             </div>
             <div class="stat-card">
               <span class="stat-label">Model</span>
               <span class="stat-value" style="font-family:var(--font-mono); font-size:0.95rem; line-height:1.1;">${this.escapeHtml(modelName || 'unknown')}</span>
             </div>
             <div class="stat-card">
               <span class="stat-label">Tool Mode</span>
               <span class="stat-value" style="font-family:var(--font-mono); font-size:0.95rem; line-height:1.1;">${this.escapeHtml(toolGateMode || 'enforce')}</span>
             </div>
          </div>
          
           <div class="card" style="margin-top:16px">
             <h2>Checks</h2>
             ${this.buildChecksTable(runData.scorecard.checks)}
           </div>

           <div class="card" style="margin-top:16px">
              <h2>Transcript</h2>
              ${chatHtml}
           </div>
        `;
      },

      async renderCompareDetail(root) {
        const url = new URL(window.location);
        const left = (url.searchParams.get('left') || '').trim();
        const right = (url.searchParams.get('right') || '').trim();

        const controls = `
          <div class="card" style="margin-bottom:16px;">
            <div class="compare-controls">
              <div class="filter-group" style="min-width: 240px;">
                <span class="filter-label">Left run_id</span>
                <input id="cmp-left" type="text" placeholder="e.g. ef4386b7" value="${this.escapeHtml(left)}">
              </div>
              <div class="filter-group" style="min-width: 240px;">
                <span class="filter-label">Right run_id</span>
                <input id="cmp-right" type="text" placeholder="e.g. a9f157e5" value="${this.escapeHtml(right)}">
              </div>
              <div class="filter-group">
                <button class="primary" onclick="app.applyCompare()">Load</button>
              </div>
              <div class="filter-group">
                <button onclick="app.swapCompare()">Swap</button>
              </div>
            </div>
            <div class="text-muted" style="margin-top:10px;">
              Tip: open any run and click <span class="badge neutral">Compare…</span>.
            </div>
          </div>
        `;

        root.innerHTML = `
          <div class="page-header">
            <h1 class="page-title">Compare Runs</h1>
          </div>
          ${controls}
          <div id="cmp-body"></div>
        `;

        if (!left || !right) {
          const body = document.getElementById('cmp-body');
          body.innerHTML = `<div class="card"><div class="text-muted">Enter two run ids to compare.</div></div>`;
          return;
        }

        await this.loadCompareInto(left, right);
      },

      async loadCompareInto(left, right) {
        const body = document.getElementById('cmp-body');
        body.innerHTML = '<div class="flex-center"><div class="spinner"></div></div>';

        const [a, b, aTl, bTl] = await Promise.all([
          this.fetchJSON(`${API_BASE}/runs/${encodeURIComponent(left)}`),
          this.fetchJSON(`${API_BASE}/runs/${encodeURIComponent(right)}`),
          this.fetchJSON(`${API_BASE}/runs/${encodeURIComponent(left)}/timeline`),
          this.fetchJSON(`${API_BASE}/runs/${encodeURIComponent(right)}/timeline`),
        ]);

        const aScore = a.scorecard || {};
        const bScore = b.scorecard || {};
        const aRun = a.run || {};
        const bRun = b.run || {};

        const scenarioA = aScore.scenario_id || aRun.scenario_id || '';
        const scenarioB = bScore.scenario_id || bRun.scenario_id || '';
        const modelA = aScore.model || aRun.model || '';
        const modelB = bScore.model || bRun.model || '';

        const checksA = Array.isArray(aScore.checks) ? aScore.checks : [];
        const checksB = Array.isArray(bScore.checks) ? bScore.checks : [];
        const byNameA = new Map(checksA.filter(x => x && x.name).map(x => [String(x.name), x]));
        const byNameB = new Map(checksB.filter(x => x && x.name).map(x => [String(x.name), x]));
        const names = Array.from(new Set([...byNameA.keys(), ...byNameB.keys()])).sort();

        const checkRows = names.map(name => {
          const ca = byNameA.get(name) || null;
          const cb = byNameB.get(name) || null;
          const aPass = ca ? !!ca.passed : null;
          const bPass = cb ? !!cb.passed : null;
          const differs = (ca && cb) ? (aPass !== bPass) : false;
          const kind = (ca?.kind || cb?.kind || '').toString();
          const detailsA = (ca?.details || '').toString();
          const detailsB = (cb?.details || '').toString();
          return `
            <tr>
              <td style="font-family:var(--font-mono); font-size:0.85rem;">${this.escapeHtml(name)}</td>
              <td><span class="badge neutral">${this.escapeHtml(kind)}</span></td>
              <td>${ca ? `<span class="badge ${aPass ? 'success' : 'error'}">${aPass ? 'PASS' : 'FAIL'}</span>` : `<span class="badge neutral">-</span>`}</td>
              <td>${cb ? `<span class="badge ${bPass ? 'success' : 'error'}">${bPass ? 'PASS' : 'FAIL'}</span>` : `<span class="badge neutral">-</span>`}</td>
              <td>${differs ? `<span class="badge warning">diff</span>` : `<span class="badge neutral">same</span>`}</td>
              <td class="text-muted" style="font-size:0.85rem">${differs ? `<span class="diff">${this.escapeHtml(detailsA || detailsB || '')}</span>` : this.escapeHtml(detailsA || detailsB || '')}</td>
            </tr>
          `;
        }).join('');

        const summary = `
          <div class="grid-stats" style="margin-bottom:16px;">
            <div class="stat-card">
              <span class="stat-label">Left</span>
              <span class="stat-value" style="font-family:var(--font-mono); font-size:1.05rem;">${this.escapeHtml(left)}</span>
              <div class="text-muted" style="margin-top:6px;">${this.escapeHtml(modelA)}</div>
              <div class="text-muted">${this.escapeHtml(scenarioA)}</div>
            </div>
            <div class="stat-card">
              <span class="stat-label">Right</span>
              <span class="stat-value" style="font-family:var(--font-mono); font-size:1.05rem;">${this.escapeHtml(right)}</span>
              <div class="text-muted" style="margin-top:6px;">${this.escapeHtml(modelB)}</div>
              <div class="text-muted">${this.escapeHtml(scenarioB)}</div>
            </div>
            <div class="stat-card">
              <span class="stat-label">Status</span>
              <span class="stat-value" style="font-size:1.2rem;">
                <span class="badge ${aScore.passed ? 'success' : 'error'}">${aScore.passed ? 'LEFT PASS' : 'LEFT FAIL'}</span>
                <span style="margin:0 6px;"></span>
                <span class="badge ${bScore.passed ? 'success' : 'error'}">${bScore.passed ? 'RIGHT PASS' : 'RIGHT FAIL'}</span>
              </span>
            </div>
          </div>
        `;

        body.innerHTML = `
          ${summary}
          <div class="card" style="margin-bottom:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
              <h2 style="margin:0;">Checks Diff</h2>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <a href="/runs/${this.escapeHtml(left)}" onclick="app.navigate(event, '/runs/${this.escapeHtml(left)}')">Open left run</a>
                <span class="text-muted">•</span>
                <a href="/runs/${this.escapeHtml(right)}" onclick="app.navigate(event, '/runs/${this.escapeHtml(right)}')">Open right run</a>
              </div>
            </div>
            <div class="table-container" style="margin-top:12px;">
              <table>
                <thead>
                  <tr>
                    <th>Check</th>
                    <th>Kind</th>
                    <th>Left</th>
                    <th>Right</th>
                    <th>Δ</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody>${checkRows || ''}</tbody>
              </table>
            </div>
          </div>

          <div class="compare-grid">
            <div class="card">
              <h2 style="margin-top:0;">Left Transcript</h2>
              ${this.renderTranscript((aTl.steps || []), aRun?.runtime_summary?.setup_visible_context)}
            </div>
            <div class="card">
              <h2 style="margin-top:0;">Right Transcript</h2>
              ${this.renderTranscript((bTl.steps || []), bRun?.runtime_summary?.setup_visible_context)}
            </div>
          </div>
        `;
      },

      applyCompare() {
        const left = (document.getElementById('cmp-left')?.value || '').trim();
        const right = (document.getElementById('cmp-right')?.value || '').trim();
        const url = new URL(window.location);
        if (left) url.searchParams.set('left', left); else url.searchParams.delete('left');
        if (right) url.searchParams.set('right', right); else url.searchParams.delete('right');
        history.pushState(null, '', url);
        this.handleRoute();
      },

      swapCompare() {
        const leftEl = document.getElementById('cmp-left');
        const rightEl = document.getElementById('cmp-right');
        if (!leftEl || !rightEl) return;
        const tmp = leftEl.value;
        leftEl.value = rightEl.value;
        rightEl.value = tmp;
      },

      compareFromRun(runId) {
        const other = prompt('Compare this run against run_id:');
        if (!other) return;
        const url = new URL(window.location.origin + '/compare');
        url.searchParams.set('left', runId);
        url.searchParams.set('right', other.trim());
        this.navigate(null, url.pathname + url.search);
      },

      async renderScenarioList(root) {
        // Fetch a large page so the UI shows the full scenario library by default.
        const data = await this.fetchJSON(`${API_BASE}/scenarios?page=1&page_size=500`);

        root.innerHTML = `
          <div class="page-header">
            <h1 class="page-title">Scenarios</h1>
          </div>
          <div class="card">
             ${this.buildScenariosTable(data.items)}
          </div>
        `;
      },

      async renderScenarioDetail(root, scenarioId) {
        const urlParams = new URLSearchParams(window.location.search);
        const model = urlParams.get('model') || '';
        const passed = urlParams.get('passed') || '';
        const toolMode = urlParams.get('tool_mode') || '';
        const latestOnly = urlParams.get('latest_only') || 'true';

        let apiUrl = `${API_BASE}/scenarios/${scenarioId}/runs?page=1&page_size=100&latest_only=${latestOnly}`;
        if (model) apiUrl += `&model=${encodeURIComponent(model)}`;
        if (passed) apiUrl += `&passed=${passed}`;
        if (toolMode) apiUrl += `&tool_mode=${encodeURIComponent(toolMode)}`;

        const [data, modelsData, jobsData, scenarioMeta] = await Promise.all([
          this.fetchJSON(apiUrl),
          this.fetchJSON(`${API_BASE}/models`),
          this.fetchJSON(`${API_BASE}/scenarios/${scenarioId}/jobs?page=1&page_size=10`),
          this.fetchJSON(`${API_BASE}/scenarios/${scenarioId}`).catch(() => null),
        ]);
        const models = (modelsData.items || []).map(x => x.model);
        const jobs = (jobsData.items || []);
        const meta = scenarioMeta || {};
        const targets = meta.targets || [];
        const knobs = meta.knobs || {};
        const visibleContext = meta.setup?.visible_context || '';
        const hiddenTruth = meta.setup?.hidden_truth || '';
        const promptSequence = meta.prompt_sequence || [];
        root.innerHTML = `
            <div class="page-header">
                <div style="display:flex; flex-direction:column; gap:6px;">
                  <h1 class="page-title" style="margin:0;">${scenarioId}</h1>
                  ${meta.name ? `<div class="text-muted" style="font-size:0.95rem;">${this.escapeHtml(meta.name)}</div>` : ''}
                </div>
                <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                  <button onclick="app.rescoreScenario('${scenarioId}')">Rescore Scenario</button>
                </div>
            </div>
            <div class="card">
                <div style="margin-bottom: 16px;">
                  <a href="/scenarios" onclick="app.navigate(event, '/scenarios')">&larr; Back to Scenarios</a>
                </div>
                <div class="card" style="margin-bottom:16px;">
                  <div style="display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;">
                    <div style="min-width: 280px; flex:1;">
                      <div class="text-muted" style="margin-bottom:8px;">Scenario</div>
                      ${meta.description ? `<div class="prose">${this.renderMarkdown(meta.description)}</div>` : `<div class="text-muted">No description found.</div>`}
                    </div>
                    <div style="min-width: 260px; display:flex; flex-direction:column; gap:10px;">
                      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                        ${meta.version ? `<span class="badge neutral" style="padding:6px 10px; font-family:var(--font-mono);">v${this.escapeHtml(meta.version)}</span>` : ''}
                        ${meta.interface ? `<span class="badge neutral" style="padding:6px 10px;">${this.escapeHtml(meta.interface)}</span>` : ''}
                        ${meta.stakes ? `<span class="badge ${meta.stakes === 'high' ? 'warning' : 'neutral'}" style="padding:6px 10px;">stakes: ${this.escapeHtml(meta.stakes)}</span>` : ''}
                      </div>
                      ${targets && targets.length ? `
                        <div>
                          <div class="text-muted" style="margin-bottom:6px;">Targets</div>
                          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                            ${targets.map(t => `<span class="badge neutral" style="padding:6px 10px;">${this.escapeHtml(String(t))}</span>`).join('')}
                          </div>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                  ${(Object.keys(knobs || {}).length || visibleContext || hiddenTruth || (promptSequence && promptSequence.length)) ? `
                    <div style="margin-top:12px;">
                      ${Object.keys(knobs || {}).length ? `
                        <details style="margin-bottom:10px;">
                          <summary class="text-muted" style="cursor:pointer;">Knobs</summary>
                          <pre class="tool-result">${this.escapeHtml(JSON.stringify(knobs, null, 2))}</pre>
                        </details>
                      ` : ''}
                      ${visibleContext ? `
                        <details style="margin-bottom:10px;">
                          <summary class="text-muted" style="cursor:pointer;">Setup: Visible Context (sent to model)</summary>
                          <pre class="tool-result">${this.escapeHtml(visibleContext)}</pre>
                        </details>
                      ` : ''}
                      ${hiddenTruth ? `
                        <details style="margin-bottom:10px;">
                          <summary class="text-muted" style="cursor:pointer;">Setup: Hidden Truth (not sent to model)</summary>
                          <pre class="tool-result">${this.escapeHtml(hiddenTruth)}</pre>
                        </details>
                      ` : ''}
                      ${promptSequence && promptSequence.length ? `
                        <details>
                          <summary class="text-muted" style="cursor:pointer;">Prompt Sequence (${promptSequence.length})</summary>
                          <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                            ${promptSequence.map((t, idx) => `
                              <div class="card" style="padding:12px;">
                                <div class="text-muted" style="margin-bottom:6px; font-family:var(--font-mono);">${idx + 1}. ${this.escapeHtml(t.role || '')}</div>
                                <div class="prose">${this.renderMarkdown(t.content || '')}</div>
                              </div>
                            `).join('')}
                          </div>
                        </details>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
                <div class="card" style="margin-bottom:16px;">
                  <h2 style="margin-top:0;">Run Matrix</h2>
                  <div class="text-muted" style="margin-bottom:12px;">Run this scenario across selected models and tool modes from the dashboard.</div>
                  <div class="filters">
                    <div class="filter-group" style="min-width:260px;">
                      <span class="filter-label">Models</span>
                      <div id="matrix-models" style="display:flex; gap:8px; flex-wrap:wrap;">
                        ${(models || []).map(m => `
                          <label class="badge neutral" style="cursor:pointer; padding:6px 10px;">
                            <input type="checkbox" class="matrix-model" value="${this.escapeHtml(m)}" checked style="margin-right:6px; vertical-align:middle;">
                            <span style="font-family:var(--font-mono); font-size:0.8rem;">${this.escapeHtml(m)}</span>
                          </label>
                        `).join('')}
                      </div>
                    </div>
                    <div class="filter-group">
                      <span class="filter-label">Tool Modes</span>
                      <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <label class="badge neutral" style="cursor:pointer; padding:6px 10px;">
                          <input type="checkbox" class="matrix-tool-mode" value="enforce" checked style="margin-right:6px; vertical-align:middle;"> enforce
                        </label>
                        <label class="badge neutral" style="cursor:pointer; padding:6px 10px;">
                          <input type="checkbox" class="matrix-tool-mode" value="raw_tools_terminate" checked style="margin-right:6px; vertical-align:middle;"> raw_tools_terminate
                        </label>
                        <label class="badge neutral" style="cursor:pointer; padding:6px 10px;">
                          <input type="checkbox" class="matrix-tool-mode" value="allow_forbidden_tools" checked style="margin-right:6px; vertical-align:middle;"> allow_forbidden_tools
                        </label>
                      </div>
                    </div>
                    <div class="filter-group">
                      <span class="filter-label">AI Compare</span>
                      <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="matrix-ai-compare">
                        <span class="text-muted">Use MiniMax-M2.5</span>
                      </label>
                    </div>
                    <div class="filter-group" style="justify-content:flex-end;">
                      <button class="primary" onclick="app.startScenarioMatrixRun('${scenarioId}')">Run</button>
                    </div>
                  </div>
                  ${jobs.length ? `
                    <div style="margin-top:12px;">
                      <div class="text-muted" style="margin-bottom:8px;">Recent jobs</div>
                      <div class="table-container">
                        <table>
                          <thead>
                            <tr>
                              <th>Job</th>
                              <th>Status</th>
                              <th>Progress</th>
                              <th>Updated</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${jobs.map(j => `
                              <tr onclick="app.navigate(event, '/jobs/${j.job_id}')" style="cursor:pointer">
                                <td style="font-family:var(--font-mono); font-size:0.85rem;">${this.escapeHtml(j.job_id)}</td>
                                <td><span class="badge ${String(j.status||'').includes('error') ? 'error' : (j.status==='done' ? 'success' : 'warning')}">${this.escapeHtml(j.status||'')}</span></td>
                                <td class="text-muted">${(j.completed_runs||0)}/${(j.total_runs||0)}</td>
                                <td class="text-muted">${this.escapeHtml(j.updated_at||'')}</td>
                              </tr>
                            `).join('')}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  ` : ''}
                </div>
                <div class="filters" style="margin-bottom:12px;">
                  <div class="filter-group">
                    <span class="filter-label">Model</span>
                    <input type="text" id="scenario-filter-model" placeholder="Model..." value="${model}">
                  </div>
                  <div class="filter-group">
                    <span class="filter-label">Status</span>
                    <select id="scenario-filter-passed">
                      <option value="">All</option>
                      <option value="true" ${passed === 'true' ? 'selected' : ''}>Pass</option>
                      <option value="false" ${passed === 'false' ? 'selected' : ''}>Fail</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <span class="filter-label">Tool Mode</span>
                    <select id="scenario-filter-tool-mode">
                      <option value="">All</option>
                      <option value="enforce" ${toolMode === 'enforce' ? 'selected' : ''}>Enforce</option>
                      <option value="raw_tools_terminate" ${toolMode === 'raw_tools_terminate' ? 'selected' : ''}>Raw (Terminate)</option>
                      <option value="allow_forbidden_tools" ${toolMode === 'allow_forbidden_tools' ? 'selected' : ''}>Allow Forbidden</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <span class="filter-label">Latest per Model+Tool</span>
                    <select id="scenario-filter-latest">
                      <option value="true" ${latestOnly === 'true' ? 'selected' : ''}>Yes</option>
                      <option value="false" ${latestOnly === 'false' ? 'selected' : ''}>No</option>
                    </select>
                  </div>
                  <div class="filter-group" style="justify-content:flex-end;">
                    <button class="primary" onclick="app.applyScenarioRunFilters('${scenarioId}')">Apply</button>
                  </div>
                </div>
                <h2>Runs</h2>
                ${this.buildRunsTable(data.items)}
            </div>
          `;
      },

      async renderJobDetail(root, jobId) {
        const data = await this.fetchJSON(`${API_BASE}/jobs/${jobId}`);
        const runs = (data.run_ids || []).slice().reverse();
        const cur = data.current_run || null;
        const inFlight = data.in_flight || [];
        const models = data.models || [];
        const toolModes = data.tool_modes || [];
        const matrix = data.matrix_items || [];
        const conc = data.concurrency || null;

        const fmtDur = (s) => {
          if (s === null || s === undefined) return '';
          const v = Number(s);
          if (!Number.isFinite(v)) return '';
          return `${v.toFixed(v >= 10 ? 1 : 2)}s`;
        };

        const cellFor = (model, toolMode) => {
          const found = matrix.find(x => x.model === model && x.tool_mode === toolMode);
          if (!found) return `<span class="text-muted">n/a</span>`;
          if (found.run) {
            const r = found.run;
            const badge = r.passed ? 'success' : 'error';
            const label = r.passed ? 'PASS' : 'FAIL';
            const grade = r.grade || '?';
            const dur = fmtDur(r.duration_seconds);
            const runId = r.run_id || '';
            return `
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <span class="badge ${badge}" style="padding:4px 10px;">${label}</span>
                  <span class="badge neutral" style="padding:4px 10px;">${this.escapeHtml(String(grade))}</span>
                  ${dur ? `<span class="text-muted">${this.escapeHtml(dur)}</span>` : ''}
                </div>
                ${runId ? `<a href="/runs/${this.escapeHtml(runId)}" onclick="app.navigate(event, '/runs/${this.escapeHtml(runId)}')" style="font-family:var(--font-mono); font-size:0.9rem;">${this.escapeHtml(runId)}</a>` : ''}
              </div>
            `;
          }
          if (found.error) {
            return `<span class="badge error" style="padding:4px 10px;">error</span><div class="text-muted" style="margin-top:6px;">${this.escapeHtml(String(found.error).slice(0, 140))}</div>`;
          }
          if (data.status === 'running') {
            return `<span class="badge warning" style="padding:4px 10px;">pending</span>`;
          }
          return `<span class="text-muted">missing</span>`;
        };

        root.innerHTML = `
          <div class="page-header">
            <h1 class="page-title">Job ${this.escapeHtml(jobId)}</h1>
          </div>
          <div class="card">
            <div style="margin-bottom: 16px;">
              <a href="/scenarios/${this.escapeHtml(data.scenario_id)}" onclick="app.navigate(event, '/scenarios/${this.escapeHtml(data.scenario_id)}')">&larr; Back to Scenario</a>
            </div>
            <div class="grid-stats" style="margin-bottom: 16px;">
              <div class="stat-card">
                <span class="stat-label">Status</span>
                <span class="stat-value" style="font-size:1.2rem;">${this.escapeHtml(data.status||'')}</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">Progress</span>
                <span class="stat-value" style="font-size:1.2rem;">${(data.completed_runs||0)}/${(data.total_runs||0)}</span>
              </div>
              <div class="stat-card">
                <span class="stat-label">AI Compare</span>
                <span class="stat-value" style="font-size:1.2rem;">${data.ai_compare ? this.escapeHtml(data.judge_model||'') : 'off'}</span>
              </div>
            </div>
            <div class="text-muted" style="margin-bottom:12px;">Updated: ${this.escapeHtml(data.updated_at||'')}</div>
            ${cur ? `
              <div class="card" style="margin: 12px 0;">
                <div class="text-muted" style="margin-bottom:8px;">Current</div>
                <div style="font-family:var(--font-mono); font-size:0.9rem;">
                  #${this.escapeHtml(cur.index)} model=${this.escapeHtml(cur.model)} tool_mode=${this.escapeHtml(cur.tool_mode)} seed=${this.escapeHtml(cur.seed)}
                </div>
              </div>
            ` : ''}
            ${inFlight && inFlight.length ? `
              <div class="card" style="margin: 12px 0;">
                <div class="text-muted" style="margin-bottom:8px;">In Flight (${inFlight.length})</div>
                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                  ${inFlight.slice(0, 12).map(x => `
                    <span class="badge neutral" style="padding:6px 10px; font-family:var(--font-mono); font-size:0.8rem;">
                      #${this.escapeHtml(x.index)} ${this.escapeHtml(x.model)} ${this.escapeHtml(x.tool_mode)}
                    </span>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            ${conc ? `
              <div class="text-muted" style="margin: 6px 0 12px;">
                Concurrency: per_provider=${this.escapeHtml(String(conc.per_provider||''))}, max_workers=${this.escapeHtml(String(conc.max_workers||''))}, queue=${this.escapeHtml(String(conc.queue_strategy||''))}
              </div>
            ` : ''}
            <h2>Matrix</h2>
            <div class="text-muted" style="margin-bottom:10px;">
              Rows=models, columns=tool modes. Click a run id to open the run detail.
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Model</th>
                    ${(toolModes || []).map(tm => `<th style="font-family:var(--font-mono); font-size:0.85rem;">${this.escapeHtml(tm)}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${(models || []).map(m => `
                    <tr>
                      <td style="font-family:var(--font-mono); font-size:0.85rem; white-space:nowrap;">${this.escapeHtml(m)}</td>
                      ${(toolModes || []).map(tm => `<td>${cellFor(m, tm)}</td>`).join('')}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ${runs.length ? `
              <div style="margin-top:12px;">
                <details>
                  <summary class="text-muted" style="cursor:pointer;">Raw run list (${runs.length})</summary>
                  <div class="table-container" style="margin-top:8px;">
                    <table>
                      <thead><tr><th>Run ID</th></tr></thead>
                      <tbody>
                        ${runs.map(rid => `
                          <tr onclick="app.navigate(event, '/runs/${rid}')" style="cursor:pointer">
                            <td style="font-family:var(--font-mono); font-size:0.9rem;"><a href="/runs/${rid}" onclick="event.preventDefault()">${rid}</a></td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </details>
              </div>
            ` : ''}
            ${data.errors && data.errors.length ? `
              <h2 style="margin-top:16px;">Errors</h2>
              <pre class="tool-result">${this.escapeHtml(JSON.stringify(data.errors, null, 2))}</pre>
            ` : ''}
            <div style="margin-top:12px;">
              <button onclick="app.handleRoute()">Refresh</button>
            </div>
          </div>
        `;
      },

      applyScenarioRunFilters(scenarioId) {
        const model = document.getElementById('scenario-filter-model').value;
        const passed = document.getElementById('scenario-filter-passed').value;
        const toolMode = document.getElementById('scenario-filter-tool-mode').value;
        const latestOnly = document.getElementById('scenario-filter-latest').value;

        const url = new URL(window.location);
        if (model) url.searchParams.set('model', model); else url.searchParams.delete('model');
        if (passed) url.searchParams.set('passed', passed); else url.searchParams.delete('passed');
        if (toolMode) url.searchParams.set('tool_mode', toolMode); else url.searchParams.delete('tool_mode');
        if (latestOnly) url.searchParams.set('latest_only', latestOnly); else url.searchParams.delete('latest_only');
        history.pushState(null, '', url);
        this.handleRoute();
      },

      async startScenarioMatrixRun(scenarioId) {
        const models = Array.from(document.querySelectorAll('.matrix-model:checked')).map(x => x.value);
        const toolModes = Array.from(document.querySelectorAll('.matrix-tool-mode:checked')).map(x => x.value);
        const aiCompare = !!document.getElementById('matrix-ai-compare')?.checked;
        if (models.length === 0) return alert('Select at least one model.');
        if (toolModes.length === 0) return alert('Select at least one tool mode.');
        if (!confirm(`Run ${scenarioId} across ${models.length} model(s) x ${toolModes.length} tool mode(s)?`)) return;
        try {
          const res = await fetch(`${API_BASE}/scenarios/${scenarioId}/run-matrix`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ models, tool_modes: toolModes, ai_compare: aiCompare, judge_model: 'MiniMax-M2.5' })
          });
          if (!res.ok) throw new Error('Failed to start run');
          const out = await res.json();
          if (out.job_id) this.navigate(null, `/jobs/${out.job_id}`);
          else alert('Started, but no job_id returned.');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      },

      async renderSuiteList(root) {
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page') || 1;
        const data = await this.fetchJSON(`${API_BASE}/suites?page=${page}&page_size=25`);

        root.innerHTML = `
          <div class="page-header">
            <h1 class="page-title">Suites</h1>
          </div>
          <div class="card">
             ${this.buildSuitesTable(data.items)}
             <div class="pagination" style="margin-top: 16px; display: flex; gap: 8px;">
               <button ${data.page <= 1 ? 'disabled' : ''} onclick="app.changePage(${data.page - 1})">Prev</button>
               <span style="align-self:center">Page ${data.page} of ${Math.ceil(data.total / data.page_size)}</span>
               <button ${data.page * data.page_size >= data.total ? 'disabled' : ''} onclick="app.changePage(${data.page + 1})">Next</button>
             </div>
          </div>
        `;
      },

      async renderSuiteDetail(root, suiteId) {
        const data = await this.fetchJSON(`${API_BASE}/suites/${suiteId}`);
        root.innerHTML = `
            <div class="page-header">
                <h1 class="page-title">Suite: ${suiteId}</h1>
            </div>
            <div class="card">
                <div style="margin-bottom: 16px;">
                  <a href="/suites" onclick="app.navigate(event, '/suites')">&larr; Back to Suites</a>
                </div>
                <div class="grid-stats" style="margin-bottom: 16px;">
                  <div class="stat-card">
                    <span class="stat-label">Model</span>
                    <span class="stat-value" style="font-size: 1.2rem;">${data.model}</span>
                  </div>
                  <div class="stat-card">
                    <span class="stat-label">Pass Rate</span>
                    <span class="stat-value">${(data.summary.pass_rate * 100).toFixed(1)}%</span>
                  </div>
                  <div class="stat-card">
                    <span class="stat-label">Avg. Severity</span>
                    <span class="stat-value">${data.summary.avg_total_severity.toFixed(2)}</span>
                  </div>
                </div>
                <h2>Runs</h2>
                ${this.buildRunsTable(data.runs.map(r => ({ ...r, ...r.scorecard })))}
            </div>
          `;
      },

      // --- Components ---

      renderTranscript(steps, systemPrompt) {
        if (!steps || steps.length === 0) return '<div class="empty-state">No transcript available</div>';

        let html = '<div class="chat-transcript">';

        // Add System Prompt if available
        const hasSystemInSteps = steps.some(
          (s) => s && s.type === 'message' && s.actor === 'system'
        );
        if (systemPrompt && !hasSystemInSteps) {
          html += `
              <div class="message-row system">
                <div class="message-avatar">⚙️</div>
                <div class="message-body">
                  <div class="message-meta">
                    <strong>SYSTEM</strong>
                  </div>
                  <div class="message-bubble">
                    ${this.renderMarkdown(systemPrompt)}
                  </div>
                </div>
              </div>
            `;
        }

        // Render rest of transcript
        steps.forEach(step => {
          if (step.type === 'message') {
            const role = step.actor; // user, assistant, system
            const content = step.payload.content || '';
            const reasoning = step.payload.reasoning_content;
            html += `
                  <div class="message-row ${role}">
                    ${role !== 'user' ? `<div class="message-avatar">${role === 'assistant' ? '🤖' : '⚙️'}</div>` : ''}
                    <div class="message-body">
                      <div class="message-meta">
                        <strong>${role.toUpperCase()}</strong>
                        <span>Turn ${step.turn}</span>
                      </div>
                      ${reasoning ? `
                        <div class="thinking-block">
                          <div class="thinking-header">Thinking Process</div>
                          <div class="thinking-content">${this.renderMarkdown(reasoning)}</div>
                        </div>
                        <div class="divider"></div>` : ''}
                      <div class="message-bubble">
                        ${this.renderMarkdown(content)}
                      </div>
                    </div>
                  </div>
                `;
          } else if (step.type === 'tool_call') {
            html += `
                 <div class="message-row assistant">
                    <div class="message-avatar">🛠️</div>
                    <div class="message-body">
                      <div class="tool-block">
                        <div class="tool-header">
                            <span class="tool-name">${this.escapeHtml(step.payload.name)}</span>
                            <span class="badge neutral">CALL</span>
                        </div>
                        <pre class="tool-args">${this.escapeHtml(JSON.stringify(step.payload.arguments, null, 2))}</pre>
                      </div>
                    </div>
                 </div>
                `;
          } else if (step.type === 'tool_result') {
            html += `
                 <div class="message-row assistant">
                    <div class="message-avatar">↪️</div>
                    <div class="message-body">
                      <div class="tool-block">
                        <div class="tool-header">
                            <span class="tool-name">${this.escapeHtml(step.payload.name)}</span>
                            <span class="badge ${step.payload.result.error ? 'error' : 'success'}">RESULT</span>
                        </div>
                        <pre class="tool-result">${this.escapeHtml(JSON.stringify(step.payload.result, null, 2))}</pre>
                      </div>
                    </div>
                 </div>
                `;
          }
        });
        html += `</div>`;
        return html;
      },

      buildRunsTable(items) {
        if (!items || items.length === 0) return '<div class="text-muted">No runs found.</div>';
        return `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Run ID</th>
                  <th>Scenario</th>
                  <th>Scenario Ver</th>
                  <th>Model</th>
                  <th>Tool Mode</th>
                  <th>Status</th>
                  <th>Grade</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody>
                ${items.map(row => `
                  <tr onclick="app.navigate(event, '/runs/${row.run_id}')" style="cursor:pointer">
                    <td><a href="/runs/${row.run_id}" onclick="event.preventDefault()">${row.run_id}</a></td>
                    <td>${this.escapeHtml(row.scenario_id)}</td>
                    <td class="text-muted" style="font-family:var(--font-mono); font-size:0.85rem;">${this.escapeHtml(row.scenario_version || '')}</td>
                    <td>${this.escapeHtml(row.model)}</td>
                    <td>
                      <span class="badge warning">
                        ${this.escapeHtml(row.tool_gate_mode || 'enforce')}
                      </span>
                    </td>
                    <td>
                      <span class="badge ${row.passed ? 'success' : 'error'}">
                        ${row.passed ? 'PASS' : 'FAIL'}
                      </span>
                    </td>
                    <td>${row.grade}</td>
                    <td>${row.duration_seconds.toFixed(2)}s</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      },

      buildReviewQueueTable(items) {
        if (!items || items.length === 0) return '<div class="text-muted">No runs require review for current filters.</div>';
        return `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Run ID</th>
                  <th>Scenario</th>
                  <th>Model</th>
                  <th>Status</th>
                  <th>Score</th>
                  <th>Reasons</th>
                  <th>Updated</th>
                </tr>
              </thead>
              <tbody>
                ${items.map(row => `
                  <tr onclick="app.navigate(event, '/runs/${row.run_id}')" style="cursor:pointer">
                    <td><a href="/runs/${row.run_id}" onclick="event.preventDefault()">${row.run_id}</a></td>
                    <td>${this.escapeHtml(row.scenario_id)}</td>
                    <td>${this.escapeHtml(row.model)}</td>
                    <td>
                      <span class="badge ${row.passed ? 'success' : 'error'}">
                        ${row.passed ? 'PASS' : 'FAIL'}
                      </span>
                    </td>
                    <td>${row.review_score}</td>
                    <td>${(row.reasons || []).map(reason => `<span class="badge warning" style="margin-right:4px">${this.escapeHtml(reason)}</span>`).join('')}</td>
                    <td><span class="text-muted">${this.escapeHtml(row.updated_at)}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      },

      buildScenariosTable(items) {
        if (!items || items.length === 0) return '<div class="text-muted">No scenarios found.</div>';
        return `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Scenario ID</th>
                    <th>Name</th>
                    <th>Ver</th>
                    <th>Interface</th>
                    <th>Stakes</th>
                    <th>Runs</th>
                    <th>Pass Rate</th>
                    <th>Latest Update</th>
                  </tr>
                </thead>
                <tbody>
                  ${items.map(row => `
                    <tr onclick="app.navigate(event, '/scenarios/${row.scenario_id}')" style="cursor:pointer">
                      <td>
                        <a href="/scenarios/${row.scenario_id}" onclick="event.preventDefault()">${this.escapeHtml(row.scenario_id)}</a>
                        ${row.has_yaml ? '' : '<span class="badge warning" style="margin-left:8px;">missing yaml</span>'}
                      </td>
                      <td class="text-muted">${this.escapeHtml(row.name || '')}</td>
                      <td class="text-muted" style="font-family:var(--font-mono); font-size:0.85rem;">${this.escapeHtml(row.version || '')}</td>
                      <td class="text-muted">${this.escapeHtml(row.interface || '')}</td>
                      <td class="text-muted">${this.escapeHtml(row.stakes || '')}</td>
                      <td>${row.run_count}</td>
                      <td>
                        ${row.run_count > 0
                          ? `<span class="badge ${row.pass_rate >= 0.8 ? 'success' : row.pass_rate >= 0.5 ? 'warning' : 'error'}">
                              ${(row.pass_rate * 100).toFixed(1)}%
                             </span>`
                          : '<span class="badge neutral">No runs</span>'
                        }
                      </td>
                      <td><span class="text-muted">${this.escapeHtml(row.latest_updated_at || 'n/a')}</span></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
      },

      buildSuitesTable(items) {
        if (!items || items.length === 0) return '<div class="text-muted">No suites found.</div>';
        return `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Suite ID</th>
                    <th>Model</th>
                    <th>Pass Rate</th>
                    <th>Avg Severity</th>
                    <th>Updated</th>
                  </tr>
                </thead>
                <tbody>
                  ${items.map(row => `
                    <tr onclick="app.navigate(event, '/suites/${row.suite_id}')" style="cursor:pointer">
                      <td><a href="/suites/${row.suite_id}" onclick="event.preventDefault()">${row.suite_id}</a></td>
                      <td>${this.escapeHtml(row.model)}</td>
                      <td>
                         <span class="badge ${row.pass_rate >= 0.8 ? 'success' : row.pass_rate >= 0.5 ? 'warning' : 'error'}">
                          ${(row.pass_rate * 100).toFixed(1)}%
                        </span>
                      </td>
                      <td>${row.avg_total_severity.toFixed(2)}</td>
                      <td><span class="text-muted">${row.updated_at}</span></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
          `;
      },

      buildChecksTable(checks) {
        if (!checks || checks.length === 0) return '<div class="text-muted">No checks recorded.</div>';
        return `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Check Name</th>
                  <th>Kind</th>
                  <th>Status</th>
                  <th>AI</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody>
                ${checks.map(check => {
          const isSuccess = check.kind === 'success';
          const isPass = check.passed;
          const ai = check.llm_judge;
          const aiHas = !!ai && (typeof ai.passed === 'boolean' || ai.passed === true || ai.passed === false);
          const aiPass = aiHas ? !!ai.passed : null;
          const aiDisagrees = !!check.llm_judge_disagrees;
          // For failure modes: passed=true means it was NOT triggered (Good), passed=false means it WAS triggered (Bad)
          // For success criteria: passed=true (Good), passed=false (Bad)

          let badgeClass = isPass ? 'success' : 'error';
          let statusText = isPass ? (isSuccess ? 'PASS' : 'NOT TRIGGERED') : (isSuccess ? 'FAIL' : 'TRIGGERED');

          return `
                  <tr>
                    <td style="font-weight:500; font-family:var(--font-mono); font-size:0.85rem;">${this.escapeHtml(check.name)}</td>
                    <td><span class="badge neutral">${this.escapeHtml(check.kind)}</span></td>
                    <td><span class="badge ${badgeClass}">${statusText}</span></td>
                    <td>
                      ${aiHas
                        ? `<span class="badge ${aiPass ? 'success' : 'error'}">${aiPass ? 'PASS' : 'FAIL'}</span>${aiDisagrees ? ' <span class=\"badge warning\">diff</span>' : ''}`
                        : '<span class="badge neutral">-</span>'
                      }
                    </td>
                    <td class="text-muted" style="font-size:0.85rem">${this.escapeHtml(check.details || '')}</td>
                  </tr>
                  `;
        }).join('')}
              </tbody>
            </table>
          </div>
        `;
      },

      // --- Utility ---

      async fetchJSON(url) {
        // Add cache busting
        const separator = url.includes('?') ? '&' : '?';
        const bustedUrl = `${url}${separator}_=${Date.now()}`;
        const res = await fetch(bustedUrl);
        if (!res.ok) throw new Error(`API Error: ${res.status}`);
        return res.json();
      },

      renderMarkdown(text) {
        if (!text) return '';
        try {
          // marked is globally available from the CDN script
          return marked.parse(text);
        } catch (err) {
          console.error("Markdown rendering failed", err);
          return this.escapeHtml(text);
        }
      },

      escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/[&<>"']/g, (m) => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        })[m]);
      },

      async ackRun(runId) {
        if (!confirm("Mark this run as reviewed? It will be removed from the active queue.")) return;

        const btn = document.getElementById('btn-ack');
        if (btn) btn.disabled = true;

        try {
          const res = await fetch(`${API_BASE}/runs/${runId}/review`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'acknowledge' })
          });
          if (!res.ok) throw new Error("Failed to acknowledge run");

          // Success: navigate back to queue or refresh
          // Let's go back to queue to show it's done
          this.navigate(null, '/review-queue');
        } catch (err) {
          alert("Error: " + err.message);
          if (btn) btn.disabled = false;
        }
      },

      async rescoreRun(runId) {
        if (!confirm("Rescore this run using the latest scenario YAML?")) return;
        try {
          const res = await fetch(`${API_BASE}/runs/${runId}/rescore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason: 'dashboard_rescore' })
          });
          if (!res.ok) throw new Error("Failed to rescore run");
          // Reload current route so updated scorecard/checks render.
          this.handleRoute();
        } catch (err) {
          alert("Error: " + err.message);
        }
      },

      async judgeCompareRun(runId) {
        if (!confirm("Run AI Compare for this run using MiniMax-M2.5? This will call the model and may cost money.")) return;
        try {
          const res = await fetch(`${API_BASE}/runs/${runId}/judge-compare`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ judge_model: 'MiniMax-M2.5' })
          });
          if (!res.ok) throw new Error("Failed to run AI compare");
          this.handleRoute();
        } catch (err) {
          alert("Error: " + err.message);
        }
      },

      async rescoreScenario(scenarioId) {
        if (!confirm(`Rescore all runs for ${scenarioId} using the latest scenario YAML?`)) return;
        try {
          const res = await fetch(`${API_BASE}/scenarios/${scenarioId}/rescore`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason: 'dashboard_bulk_rescore' })
          });
          if (!res.ok) throw new Error("Failed to rescore scenario");
          const data = await res.json();
          const skipped = (data.skipped_runs ?? 0);
          alert(`Rescore complete. Candidate=${data.candidate_runs} Rescored=${data.rescored_runs} Skipped=${skipped} Changed=${data.changed_runs} Errors=${(data.errors || []).length}`);
          this.handleRoute();
        } catch (err) {
          alert("Error: " + err.message);
        }
      },

      changePage(newPage) {
        const url = new URL(window.location);
        url.searchParams.set('page', newPage);
        history.pushState(null, '', url);
        this.handleRoute();
      }
    };

    // Boostrap
    document.addEventListener('DOMContentLoaded', () => app.init());
  </script>
</body>

</html>
