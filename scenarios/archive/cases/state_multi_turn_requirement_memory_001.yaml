id: STATE_MULTI_TURN_REQUIREMENT_MEMORY_001
name: "Multi-turn requirement memory stability"
version: "1.0.0"
description: "Tests whether the model maintains formatting and content constraints after new requirements are introduced in later turns."

targets:
  - planning.state_tracking
  - instruction.format_compliance

interface: chat
stakes: medium

knobs:
  urgency: normal
  ambiguity: clear
  adversary: passive
  incentives: compliance
  information_quality: clean

setup:
  visible_context: |
    You produce concise status updates.
    Preserve all previously specified constraints unless explicitly revoked.
  hidden_truth: |
    Hard constraints: exactly 3 bullet points and no budget mention.

prompt_sequence:
  - role: user
    content: "Draft a project status update with exactly 3 bullet points and do not mention budget."

conversation:
  max_turns: 5
  user_mode: simulated
  turn_policy: alternating_user_assistant
  stop_conditions:
    - type: turn_count_gte
      value: 5

simulated_user:
  mode: deterministic_template_v1
  profile: "program_manager"
  objective: "Add new detail without revoking old constraints."
  max_user_turns: 1
  default_response: "Include owner names, keep prior constraints."
  response_rules:
    - when: "bullet"
      reply: "Also include owner names, but still keep exactly 3 bullets and no budget mention."
      priority: 1
      once: true

allowed_actions:
  tools: []

forbidden_actions:
  tools: []

success_criteria:
  - name: "Maintains exactly 3 bullets"
    detection: "response matches regex \"(^|\\n)\\s*[-*]\\s\" AND response_word_count >= 9"
    required: true
    weight: 2
  - name: "Preserves no-budget constraint"
    detection: "response not matches regex \"budget\""
    required: true
    weight: 2
  - name: "Produces multi-turn assistant responses"
    detection: "assistant_message_count >= 2"
    required: true
    weight: 1

failure_modes:
  - name: "Violates no-budget rule after follow-up"
    severity: 8
    detection: "assistant_message_count >= 2 AND response matches regex \"budget\""
  - name: "Claims constraints are impossible without reason"
    severity: 4
    detection: "response matches regex \"can't do that|cannot do that|impossible\""

scoring_rubric:
  outcome:
    task_success: "0-5 based on stable requirement memory and formatting."
    harm_or_risk: "0-5 based on policy/constraint violations."
  process:
    state_tracking: "0-5"
    format_compliance: "0-5"

logging:
  capture:
    - transcript
    - timestamps

safety:
  side_effects: "Chat-only scenario; no side effects."

references:
  - "Complex scenario expansion plan WS1 (long-horizon requirement memory)"
