{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://argus.dev/schemas/scenario.schema.json",
  "title": "Argus Scenario Specification",
  "description": "Schema for Argus scenario-based model behavior evaluation scenarios.",
  "type": "object",
  "required": [
    "id", "name", "version", "description", "targets", "interface",
    "stakes", "knobs", "setup", "prompt_sequence", "allowed_actions",
    "forbidden_actions", "success_criteria", "failure_modes",
    "scoring_rubric", "logging", "safety"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[A-Z][A-Z0-9_]+$",
      "description": "Unique scenario identifier (e.g., AGENCY_EMAIL_001)"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "description": "Short human-readable name"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version (e.g., 1.0.0)"
    },
    "description": {
      "type": "string",
      "minLength": 10,
      "description": "What the scenario is testing"
    },
    "targets": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "instruction.priority_handling",
          "instruction.conflict_resolution",
          "instruction.format_compliance",
          "agency.permission_discipline",
          "agency.scope_control",
          "agency.initiative_calibration",
          "epistemics.uncertainty_calibration",
          "epistemics.verification_behavior",
          "epistemics.hallucination_avoidance",
          "planning.decomposition_quality",
          "planning.state_tracking",
          "planning.adaptation",
          "planning.clarification",
          "tool.safe_selection",
          "tool.input_validation",
          "tool.error_handling",
          "robustness.prompt_injection_resistance",
          "robustness.social_engineering_resistance",
          "robustness.confusable_instruction_handling",
          "values.bias_fairness",
          "values.helpfulness_vs_caution",
          "values.deference_balance",
          "safety.boundary_keeping",
          "social.tone_stability",
          "social.non_manipulative_interaction",
          "social.hostility_handling"
        ]
      },
      "minItems": 1,
      "maxItems": 3,
      "description": "Behavior targets from the canonical taxonomy (1-3)"
    },
    "interface": {
      "type": "string",
      "enum": ["chat", "tools", "code", "gui"],
      "description": "How the model interacts"
    },
    "stakes": {
      "type": "string",
      "enum": ["low", "medium", "high"],
      "description": "Impact level of the scenario"
    },
    "knobs": {
      "type": "object",
      "properties": {
        "urgency": {
          "type": "string",
          "enum": ["normal", "urgent", "extreme"]
        },
        "ambiguity": {
          "type": "string",
          "enum": ["clear", "underspecified", "conflicting"]
        },
        "adversary": {
          "type": "string",
          "enum": ["none", "passive", "active"]
        },
        "incentives": {
          "type": "string",
          "enum": ["speed", "accuracy", "compliance"]
        },
        "information_quality": {
          "type": "string",
          "enum": ["clean", "noisy", "misleading", "incomplete"]
        }
      },
      "additionalProperties": true,
      "description": "Pressure knob settings for this scenario"
    },
    "setup": {
      "type": "object",
      "required": ["visible_context"],
      "properties": {
        "visible_context": {
          "type": "string",
          "description": "Text provided to the model as system/context"
        },
        "hidden_truth": {
          "type": "string",
          "description": "Evaluator-only ground truth"
        }
      }
    },
    "prompt_sequence": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["role", "content"],
        "properties": {
          "role": {
            "type": "string",
            "enum": ["user", "system", "assistant", "inject"]
          },
          "content": {
            "type": "string"
          }
        }
      },
      "minItems": 1,
      "description": "Ordered turn script"
    },
    "conversation": {
      "type": "object",
      "properties": {
        "max_turns": {
          "type": "integer",
          "minimum": 1,
          "description": "Scenario-specific turn budget (capped by runner max_turns)."
        },
        "user_mode": {
          "type": "string",
          "enum": ["scripted", "simulated"],
          "description": "How user turns are provided after initial prompts."
        },
        "turn_policy": {
          "type": "string",
          "enum": [
            "assistant_until_completion",
            "alternating_user_assistant",
            "assistant_tools_then_user"
          ],
          "description": "Conversation policy for runtime turn orchestration."
        },
        "stop_conditions": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["type"],
            "properties": {
              "type": {
                "type": "string",
                "enum": [
                  "assistant_response_contains",
                  "assistant_response_matches_regex",
                  "tool_call_count_gte",
                  "turn_count_gte"
                ]
              },
              "value": {
                "oneOf": [
                  { "type": "string" },
                  { "type": "integer", "minimum": 0 }
                ]
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false,
      "description": "Optional multi-turn orchestration configuration."
    },
    "simulated_user": {
      "type": "object",
      "required": ["mode"],
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["deterministic_template_v1", "llm_roleplay_v1"],
          "description": "Simulated-user engine profile."
        },
        "profile": {
          "type": "string",
          "description": "Named persona/profile for simulated user behavior."
        },
        "objective": {
          "type": "string",
          "description": "Primary objective for simulated user replies."
        },
        "constraints": {
          "type": "string",
          "description": "Optional additional constraints for roleplay behavior."
        },
        "system_prompt": {
          "type": "string",
          "description": "Optional full override prompt for llm_roleplay_v1."
        },
        "model": {
          "type": "string",
          "description": "Optional model identifier used for llm_roleplay_v1."
        },
        "temperature": {
          "type": "number",
          "minimum": 0
        },
        "max_tokens": {
          "type": "integer",
          "minimum": 1
        },
        "seed": {
          "type": "integer"
        },
        "max_user_turns": {
          "type": "integer",
          "minimum": 1
        },
        "default_response": {
          "type": "string"
        },
        "response_rules": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["when", "reply"],
            "properties": {
              "when": { "type": "string", "minLength": 1 },
              "reply": { "type": "string", "minLength": 1 },
              "priority": { "type": "integer", "minimum": 0 },
              "once": { "type": "boolean" }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false,
      "description": "Optional simulated-user behavior config."
    },
    "turn_assertions": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "detection"],
        "properties": {
          "name": { "type": "string", "minLength": 1 },
          "detection": { "type": "string", "minLength": 1 },
          "applies_to": {
            "type": "string",
            "enum": ["assistant", "user", "any"]
          },
          "turn_start": {
            "type": "integer",
            "minimum": 1
          },
          "turn_end": {
            "type": "integer",
            "minimum": 1
          },
          "required": {
            "type": "boolean"
          },
          "weight": {
            "type": "number",
            "exclusiveMinimum": 0
          }
        },
        "additionalProperties": false
      },
      "description": "Optional turn-window assertions for multi-turn scenarios."
    },
    "dynamic_events": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "trigger", "action"],
        "properties": {
          "name": { "type": "string", "minLength": 1 },
          "description": { "type": "string" },
          "trigger": { "type": "string", "minLength": 1 },
          "mode": {
            "type": "string",
            "enum": ["once", "repeat"]
          },
          "priority": {
            "type": "integer",
            "minimum": 0
          },
          "action": {
            "type": "object",
            "required": ["type"],
            "properties": {
              "type": {
                "type": "string",
                "enum": [
                  "inject_message",
                  "update_knob",
                  "restrict_tools",
                  "terminate_run",
                  "set_flag"
                ]
              },
              "role": {
                "type": "string",
                "enum": ["system", "user", "assistant", "inject"]
              },
              "content": { "type": "string" },
              "tool_names": {
                "type": "array",
                "items": { "type": "string", "minLength": 1 }
              },
              "knob_key": { "type": "string", "minLength": 1 },
              "knob_value": {
                "oneOf": [
                  { "type": "string" },
                  { "type": "number" },
                  { "type": "boolean" }
                ]
              },
              "flag": { "type": "string", "minLength": 1 },
              "reason": { "type": "string" }
            },
            "additionalProperties": false
          }
        },
        "additionalProperties": false
      },
      "description": "Optional runtime trigger-action events for dynamic scenario flow."
    },
    "allowed_actions": {
      "type": "object",
      "properties": {
        "tools": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "description": "Explicit allow-list of actions"
    },
    "forbidden_actions": {
      "type": "object",
      "properties": {
        "tools": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "description": "Explicit deny-list of actions"
    },
    "success_criteria": {
      "type": "array",
      "items": {
        "oneOf": [
          { "type": "string" },
          {
            "type": "object",
            "required": ["name", "detection"],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "detection": { "type": "string", "minLength": 1 },
              "required": { "type": "boolean" },
              "weight": { "type": "number", "exclusiveMinimum": 0 }
            },
            "additionalProperties": false
          }
        ]
      },
      "minItems": 1,
      "description": "Measurable success definitions"
    },
    "failure_modes": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "severity", "detection"],
        "properties": {
          "name": { "type": "string" },
          "severity": { "type": "integer", "minimum": 1, "maximum": 10 },
          "detection": { "type": "string" }
        }
      },
      "minItems": 1,
      "description": "Enumerated failure modes with severity"
    },
    "scoring_rubric": {
      "type": "object",
      "properties": {
        "outcome": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "process": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        }
      },
      "description": "How to score outcome and process dimensions"
    },
    "logging": {
      "type": "object",
      "required": ["capture"],
      "properties": {
        "capture": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "safety": {
      "type": "object",
      "required": ["side_effects"],
      "properties": {
        "side_effects": {
          "type": "string",
          "description": "How dangerous actions are handled"
        }
      }
    },
    "time_budget_seconds": {
      "type": "integer",
      "minimum": 1,
      "description": "Optional time budget"
    },
    "tool_budget": {
      "type": "integer",
      "minimum": 1,
      "description": "Optional tool call budget"
    },
    "randomization": {
      "type": "object",
      "description": "Which elements may vary across trials"
    },
    "mutation": {
      "type": "object",
      "required": ["source_id", "profile", "template", "generated_at", "knob_updates"],
      "properties": {
        "source_id": { "type": "string", "minLength": 1 },
        "source_path": { "type": "string" },
        "profile": { "type": "string", "enum": ["light", "standard", "stress"] },
        "template": { "type": "string", "minLength": 1 },
        "generated_at": { "type": "string", "minLength": 1 },
        "knob_updates": {
          "type": "object",
          "minProperties": 1,
          "additionalProperties": { "type": "string" }
        }
      },
      "additionalProperties": false,
      "description": "Optional metadata for generated adversarial mutation variants."
    },
    "references": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Links/notes about why the scenario exists"
    }
  },
  "additionalProperties": false
}
